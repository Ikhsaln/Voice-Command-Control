<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Control Dashboard - PT Grahasumber Prima Elektronik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <script>
        // MQTT Configuration for Voice Control Relay System
        const MQTT_CONFIG = {
            broker: 'localhost',
            port: 9001,  // Changed from 9000 to avoid conflict
            websocketUrl: 'ws://localhost:9001/mqtt',
            clientId: 'voice-control-frontend-' + Date.now()
        };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-in { animation: fadeIn 0.3s ease-in-out; }
        .slide-in-from-top-2 { animation: slideInFromTop 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInFromTop { from { transform: translateY(-8px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="bg-background">
    <!-- Header -->
    <header class="sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
        <div class="container flex h-16 items-center justify-between px-4">
            <!-- Sidebar Trigger + Title Section -->
            <div class="flex items-center gap-3">
                <button class="flex h-8 w-8 items-center justify-center rounded-lg hover:bg-accent" title="Toggle Sidebar">
                    <i data-lucide="menu" class="h-4 w-4"></i>
                </button>
                <div class="flex items-center gap-2">
                    <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-primary/10">
                        <i data-lucide="zap" class="h-4 w-4 text-primary"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold tracking-tight">Voice Control</h1>
                        <p class="text-xs text-muted-foreground">Manage voice-activated relay devices</p>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center justify-end gap-2">
                <button id="mqttStatusBtn" class="flex items-center gap-2 px-3 py-1.5 text-xs rounded-full border transition-all duration-200 bg-emerald-100 text-emerald-700 border-emerald-200 hover:bg-emerald-200">
                    <div class="w-1 h-1 rounded-full bg-emerald-500"></div>
                    MQTT Connected
                </button>
                <button id="refreshBtn" class="h-9 w-9 rounded-lg border hover:bg-accent transition-colors flex items-center justify-center" title="Refresh">
                    <i data-lucide="refresh-cw" class="h-4 w-4"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Search Bar -->
    <div class="border-b bg-muted/30">
        <div class="container px-4 py-3">
            <div class="flex items-center gap-3">
                <!-- Search Type Dropdown -->
                <div class="relative">
                    <i data-lucide="filter" class="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"></i>
                    <select
                        id="searchTypeSelect"
                        class="pl-10 h-10 w-48 rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 transition-all duration-200"
                    >
                        <option value="all">All Fields</option>
                        <option value="object_name">Object Name</option>
                        <option value="device_name">Device Name</option>
                        <option value="part_number">Part Number</option>
                        <option value="pin">PIN</option>
                        <option value="description">Description</option>
                        <option value="status">Status</option>
                    </select>
                </div>

                <!-- Search Input -->
                <div class="relative max-w-md">
                    <i data-lucide="search" class="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"></i>
                    <input
                        id="searchInput"
                        type="text"
                        placeholder="Enter search term..."
                        class="pl-10 h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 transition-all duration-200"
                    />
                </div>

                <!-- Clear Search Button -->
                <button
                    id="clearSearchBtn"
                    class="inline-flex items-center gap-2 px-3 py-2 text-sm rounded-md border hover:bg-muted transition-colors"
                    title="Clear Search"
                    style="display: none;"
                >
                    <i data-lucide="x" class="h-4 w-4"></i>
                    Clear
                </button>
            </div>
        </div>
    </div>



    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-4 py-6">
        <!-- Statistics Cards Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="relative overflow-hidden rounded-lg border bg-card text-card-foreground shadow-sm hover:shadow-md transition-shadow">
                <div class="p-4">
                    <div class="flex items-center justify-between">
                        <div class="space-y-1">
                            <p class="text-sm font-medium text-muted-foreground">Total Devices</p>
                            <p id="totalDevices" class="text-2xl font-bold tracking-tight">--</p>
                        </div>
                        <div class="h-10 w-10 bg-primary/10 rounded-lg flex items-center justify-center">
                            <i data-lucide="cpu" class="h-5 w-5 text-primary"></i>
                        </div>
                    </div>
                    <div class="absolute bottom-0 left-0 right-0 h-1 bg-primary/10"></div>
                </div>
            </div>

            <div class="relative overflow-hidden rounded-lg border bg-card text-card-foreground shadow-sm hover:shadow-md transition-shadow">
                <div class="p-4">
                    <div class="flex items-center justify-between">
                        <div class="space-y-1">
                            <p class="text-sm font-medium text-muted-foreground">Configurations</p>
                            <p id="totalConfigs" class="text-2xl font-bold tracking-tight">--</p>
                        </div>
                        <div class="h-10 w-10 bg-blue-500/10 rounded-lg flex items-center justify-center">
                            <i data-lucide="settings" class="h-5 w-5 text-blue-500"></i>
                        </div>
                    </div>
                    <div class="absolute bottom-0 left-0 right-0 h-1 bg-blue-500/10"></div>
                </div>
            </div>

            <div class="relative overflow-hidden rounded-lg border bg-card text-card-foreground shadow-sm hover:shadow-md transition-shadow">
                <div class="p-4">
                    <div class="flex items-center justify-between">
                        <div class="space-y-1">
                            <p class="text-sm font-medium text-muted-foreground">Voice Control</p>
                            <div id="voiceControlStatus" class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-gray-400"></div>
                                <span class="text-sm font-medium">Inactive</span>
                            </div>
                        </div>
                        <div class="h-10 w-10 bg-orange-500/10 rounded-lg flex items-center justify-center">
                            <i data-lucide="mic" class="h-5 w-5 text-orange-500"></i>
                        </div>
                    </div>
                    <div class="absolute bottom-0 left-0 right-0 h-1 bg-orange-500/10"></div>
                </div>
            </div>

            <div class="relative overflow-hidden rounded-lg border bg-card text-card-foreground shadow-sm hover:shadow-md transition-shadow">
                <div class="p-4">
                    <div class="flex items-center justify-between">
                        <div class="space-y-1">
                            <p class="text-sm font-medium text-muted-foreground">MQTT Status</p>
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                                <span class="text-sm font-medium">Connected</span>
                            </div>
                        </div>
                        <div class="h-10 w-10 bg-emerald-500/10 rounded-lg flex items-center justify-center">
                            <i data-lucide="wifi" class="h-5 w-5 text-emerald-500"></i>
                        </div>
                    </div>
                    <div class="absolute bottom-0 left-0 right-0 h-1 bg-emerald-500/10"></div>
                </div>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
                <button id="startVoiceBtn" class="inline-flex items-center gap-2 px-4 py-2 text-sm rounded-md bg-primary text-primary-foreground hover:bg-primary/90 transition-colors">
                    <i data-lucide="play" class="h-4 w-4"></i>
                    Start Voice Control
                </button>
                <button id="stopVoiceBtn" class="inline-flex items-center gap-2 px-4 py-2 text-sm rounded-md border hover:bg-accent transition-colors" style="display: none;">
                    <i data-lucide="square" class="h-4 w-4"></i>
                    Stop Voice Control
                </button>
                <button id="testVoiceBtn" class="inline-flex items-center gap-2 px-4 py-2 text-sm rounded-md border hover:bg-accent transition-colors">
                    <i data-lucide="message-square" class="h-4 w-4"></i>
                    Test Command
                </button>
                <button id="discoverDevicesBtn" class="inline-flex items-center gap-2 px-4 py-2 text-sm rounded-md border hover:bg-accent transition-colors">
                    <i data-lucide="search" class="h-4 w-4"></i>
                    Discover Devices
                </button>
            </div>
            <button id="createConfigBtn" class="inline-flex items-center gap-2 px-4 py-2 text-sm rounded-md bg-primary text-primary-foreground hover:bg-primary/90 transition-colors">
                <i data-lucide="plus" class="h-4 w-4"></i>
                New Configuration
            </button>
        </div>

        <!-- Voice Command Results Card -->
        <div id="voiceResultsCard" class="bg-gradient-to-br from-white via-blue-50/30 to-indigo-50/50 rounded-2xl border border-blue-200/60 shadow-xl shadow-blue-100/50 overflow-hidden mb-6 backdrop-blur-sm animate-in slide-in-from-bottom-4 duration-500" style="display: none;">
            <!-- Header with clean black background -->
            <div class="relative px-6 py-5 bg-black overflow-hidden">
                <div class="relative flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <!-- Clean icon -->
                        <div class="p-3 bg-white/10 rounded-xl border border-white/20">
                            <i data-lucide="mic" class="h-6 w-6 text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-white tracking-tight">Voice Command Executed</h2>
                            <p class="text-sm text-gray-300 font-medium">Real-time speech processing results</p>
                        </div>
                    </div>

                    <!-- Status Badge -->
                    <div id="commandStatusBadge" class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-bold border">
                        <!-- Status will be set by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Content with improved spacing and modern design -->
            <div class="p-6 space-y-6">
                <!-- Recognized Speech - Highlighted -->
                <div class="space-y-3">
                    <div class="flex items-center gap-2">
                        <div class="p-1.5 bg-blue-100 rounded-lg">
                            <i data-lucide="quote" class="h-4 w-4 text-blue-600"></i>
                        </div>
                        <label class="text-sm font-bold text-gray-700 uppercase tracking-wide">Recognized Speech</label>
                    </div>
                    <div class="relative p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-200/50 shadow-inner">
                        <!-- Speech bubble effect -->
                        <div class="absolute -top-2 left-6 w-0 h-0 border-l-8 border-r-8 border-b-8 border-l-transparent border-r-transparent border-b-blue-50"></div>
                        <p id="recognizedText" class="text-base text-gray-800 font-medium font-mono leading-relaxed">No speech recognized yet</p>
                        <!-- Subtle animation -->
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent animate-shimmer rounded-xl"></div>
                    </div>
                </div>

                <!-- Command Analysis - Modern Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Action Card -->
                    <div class="group relative overflow-hidden p-4 bg-gradient-to-br from-emerald-50 to-green-50 rounded-xl border-2 border-emerald-200/60 shadow-sm hover:shadow-md transition-all duration-300 hover:scale-105">
                        <div class="absolute top-0 right-0 w-16 h-16 bg-emerald-100/50 rounded-full -mr-8 -mt-8"></div>
                        <div class="relative flex items-center gap-3 mb-2">
                            <div class="p-2 bg-emerald-100 rounded-lg group-hover:bg-emerald-200 transition-colors">
                                <i data-lucide="zap" class="h-4 w-4 text-emerald-700"></i>
                            </div>
                            <label class="text-sm font-bold text-emerald-800 uppercase tracking-wide">Action</label>
                        </div>
                        <p id="detectedAction" class="text-lg font-bold text-emerald-900 capitalize">None</p>
                    </div>

                    <!-- Target Device Card -->
                    <div class="group relative overflow-hidden p-4 bg-gradient-to-br from-purple-50 to-violet-50 rounded-xl border-2 border-purple-200/60 shadow-sm hover:shadow-md transition-all duration-300 hover:scale-105">
                        <div class="absolute top-0 right-0 w-16 h-16 bg-purple-100/50 rounded-full -mr-8 -mt-8"></div>
                        <div class="relative flex items-center gap-3 mb-2">
                            <div class="p-2 bg-purple-100 rounded-lg group-hover:bg-purple-200 transition-colors">
                                <i data-lucide="target" class="h-4 w-4 text-purple-700"></i>
                            </div>
                            <label class="text-sm font-bold text-purple-800 uppercase tracking-wide">Target Device</label>
                        </div>
                        <p id="targetDevice" class="text-lg font-bold text-purple-900">None</p>
                    </div>
                </div>

                <!-- Device Details - Enhanced -->
                <div id="deviceDetailsSection" class="space-y-4" style="display: none;">
                    <div class="flex items-center gap-2">
                        <div class="p-1.5 bg-indigo-100 rounded-lg">
                            <i data-lucide="cpu" class="h-4 w-4 text-indigo-600"></i>
                        </div>
                        <label class="text-sm font-bold text-gray-700 uppercase tracking-wide">Device Configuration</label>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Device Name -->
                        <div class="relative p-4 bg-gradient-to-br from-slate-50 to-gray-50 rounded-xl border-2 border-slate-200/60 shadow-sm hover:shadow-md transition-all duration-300">
                            <div class="absolute top-2 right-2 w-2 h-2 bg-slate-400 rounded-full animate-pulse"></div>
                            <div class="text-xs font-bold text-slate-600 uppercase tracking-wider mb-1">Device Name</div>
                            <p id="deviceNameDetail" class="text-sm font-bold text-slate-900">-</p>
                        </div>

                        <!-- PIN -->
                        <div class="relative p-4 bg-gradient-to-br from-amber-50 to-yellow-50 rounded-xl border-2 border-amber-200/60 shadow-sm hover:shadow-md transition-all duration-300">
                            <div class="absolute top-2 right-2 w-2 h-2 bg-amber-400 rounded-full animate-pulse"></div>
                            <div class="text-xs font-bold text-amber-700 uppercase tracking-wider mb-1">PIN</div>
                            <code id="devicePinDetail" class="text-sm font-bold text-amber-900 bg-amber-100 px-2 py-1 rounded">-</code>
                        </div>

                        <!-- MQTT Status -->
                        <div class="relative p-4 bg-gradient-to-br from-cyan-50 to-blue-50 rounded-xl border-2 border-cyan-200/60 shadow-sm hover:shadow-md transition-all duration-300">
                            <div class="absolute top-2 right-2 w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div>
                            <div class="text-xs font-bold text-cyan-700 uppercase tracking-wider mb-1">MQTT Status</div>
                            <p id="mqttStatusDetail" class="text-sm font-bold text-cyan-900">-</p>
                        </div>
                    </div>
                </div>

                <!-- Error Message - Modern Alert -->
                <div id="errorSection" class="space-y-3" style="display: none;">
                    <div class="flex items-center gap-2">
                        <div class="p-1.5 bg-red-100 rounded-lg">
                            <i data-lucide="alert-triangle" class="h-4 w-4 text-red-600"></i>
                        </div>
                        <label class="text-sm font-bold text-red-700 uppercase tracking-wide">Error Details</label>
                    </div>
                    <div class="relative p-4 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border-2 border-red-200/60 shadow-inner">
                        <div class="absolute -top-2 left-6 w-0 h-0 border-l-8 border-r-8 border-b-8 border-l-transparent border-r-transparent border-b-red-50"></div>
                        <p id="errorMessage" class="text-sm text-red-800 font-medium">-</p>
                        <!-- Warning animation -->
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-red-100/30 to-transparent animate-shimmer rounded-xl"></div>
                    </div>
                </div>

                <!-- Timestamp - Modern Footer -->
                <div class="pt-4 border-t-2 border-gray-100/80">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="p-1.5 bg-gray-100 rounded-lg">
                                <i data-lucide="clock" class="h-3 w-3 text-gray-600"></i>
                            </div>
                            <span class="text-xs text-gray-500 font-medium">Last updated</span>
                        </div>
                        <p id="commandTimestamp" class="text-xs text-gray-600 font-bold bg-gray-100 px-3 py-1 rounded-full">Never</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Data Table -->
        <div class="bg-card rounded-xl border border-border/50 shadow-sm overflow-hidden">
            <div class="px-6 py-5 border-b border-border/50 bg-gradient-to-r from-muted/30 to-muted/10">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-primary/10 rounded-lg">
                            <i data-lucide="database" class="h-5 w-5 text-primary"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-foreground">Voice Configurations</h2>
                            <p class="text-sm text-muted-foreground">Manage your voice-activated device configurations</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="px-3 py-1.5 bg-muted/50 rounded-md text-xs font-medium text-muted-foreground">
                            <span id="totalConfigsCount">0</span> configurations
                        </div>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="bg-muted/20 border-b border-border/50">
                            <th class="w-16 px-6 py-4 text-left">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-semibold text-muted-foreground uppercase tracking-wider">#</span>
                                </div>
                            </th>
                            <th class="min-w-[220px] px-6 py-4 text-left">
                                <div class="flex items-center gap-2 cursor-pointer select-none hover:bg-muted/50 transition-colors rounded-md px-2 py-1 -mx-2 -my-1">
                                    <span class="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Object Name</span>
                                    <i data-lucide="arrow-up-down" class="h-3.5 w-3.5 text-muted-foreground/70"></i>
                                </div>
                            </th>
                            <th class="min-w-[200px] px-6 py-4 text-left">
                                <span class="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Device</span>
                            </th>
                            <th class="min-w-[120px] px-6 py-4 text-left">
                                <span class="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Status</span>
                            </th>
                            <th class="min-w-[80px] px-6 py-4 text-left">
                                <span class="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Pin</span>
                            </th>
                            <th class="min-w-[200px] px-6 py-4 text-left">
                                <span class="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Description</span>
                            </th>
                            <th class="w-40 px-6 py-4 text-center">
                                <span class="text-xs font-semibold text-muted-foreground uppercase tracking-wider">Actions</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="configTableBody" class="divide-y divide-border/30">
                        <tr>
                            <td colspan="7" class="px-6 py-12 text-center">
                                <div class="flex flex-col items-center gap-3">
                                    <div class="p-3 bg-muted/50 rounded-full">
                                        <i data-lucide="loader-2" class="h-6 w-6 animate-spin text-muted-foreground"></i>
                                    </div>
                                    <div class="space-y-1">
                                        <p class="text-sm font-medium text-muted-foreground">Loading configurations...</p>
                                        <p class="text-xs text-muted-foreground/70">Please wait while we fetch your data</p>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Create Configuration Modal -->
    <div id="createModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-xl border border-border/50 shadow-2xl max-w-lg w-full mx-4 overflow-hidden">
            <div class="px-6 py-5 border-b border-border/50 bg-gradient-to-r from-primary/5 to-primary/10">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-primary/10 rounded-lg">
                        <i data-lucide="plus" class="h-5 w-5 text-primary"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-foreground">Create Configuration</h3>
                        <p class="text-sm text-muted-foreground">Add a new voice-activated device configuration</p>
                    </div>
                </div>
            </div>
            <form id="createForm" class="p-6 space-y-6">
                <div class="space-y-4">
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-foreground">Device</label>
                        <select id="createDevice" name="device" class="w-full px-4 py-3 text-sm rounded-lg border border-input bg-background focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all duration-200">
                            <option value="">Select Device...</option>
                        </select>
                    </div>

                    <!-- Device Details Section -->
                    <div id="deviceDetails" class="hidden space-y-3 p-4 bg-muted/30 rounded-lg border border-border/50">
                        <h4 class="text-sm font-semibold text-foreground">Device Details</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="space-y-1">
                                <label class="text-xs font-medium text-muted-foreground">Address</label>
                                <input id="createAddress" name="address" type="text" readonly class="w-full px-3 py-2 text-sm rounded-md border border-input bg-muted/50 text-muted-foreground cursor-not-allowed">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-medium text-muted-foreground">Device Bus</label>
                                <input id="createBus" name="bus" type="text" readonly class="w-full px-3 py-2 text-sm rounded-md border border-input bg-muted/50 text-muted-foreground cursor-not-allowed">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-medium text-muted-foreground">Part Number</label>
                                <input id="createPartNumber" name="part_number" type="text" readonly class="w-full px-3 py-2 text-sm rounded-md border border-input bg-muted/50 text-muted-foreground cursor-not-allowed">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-medium text-muted-foreground">MAC Address</label>
                                <input id="createMac" name="mac" type="text" readonly class="w-full px-3 py-2 text-sm rounded-md border border-input bg-muted/50 text-muted-foreground cursor-not-allowed">
                            </div>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-foreground">Object Name</label>
                        <input id="createObjectName" name="objectName" type="text" placeholder="e.g., lampu utama" class="w-full px-4 py-3 text-sm rounded-lg border border-input bg-background focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all duration-200">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-foreground">Pin</label>
                        <select id="createPin" name="pin" class="w-full px-4 py-3 text-sm rounded-lg border border-input bg-background focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all duration-200">
                            <option value="">Select Pin...</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-foreground">Description <span class="text-muted-foreground font-normal">(Optional)</span></label>
                        <input id="createDesc" name="desc" type="text" placeholder="Optional description" class="w-full px-4 py-3 text-sm rounded-lg border border-input bg-background focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all duration-200">
                    </div>
                </div>
            </form>
            <div class="px-6 py-4 border-t border-border/50 bg-muted/20 flex justify-end gap-3">
                <button id="cancelCreateBtn" class="px-4 py-2 text-sm font-medium rounded-lg border border-border hover:bg-muted transition-colors">Cancel</button>
                <button id="submitCreateBtn" class="px-4 py-2 text-sm font-medium rounded-lg bg-primary text-primary-foreground hover:bg-primary/90 transition-colors flex items-center gap-2">
                    <i data-lucide="plus" class="h-4 w-4"></i>
                    Create Configuration
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Configuration Modal -->
    <div id="editModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full overflow-hidden">
            <!-- Simple Header -->
            <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i data-lucide="edit-2" class="h-4 w-4 text-gray-600"></i>
                        <h3 class="text-base font-semibold text-gray-900">Edit Configuration</h3>
                    </div>
                    <button id="cancelEditBtn" class="p-1 hover:bg-gray-200 rounded transition-colors">
                        <i data-lucide="x" class="h-4 w-4 text-gray-500"></i>
                    </button>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div class="max-h-96 overflow-y-auto">
                <div class="p-4 space-y-4">
                    <input id="editId" type="hidden">

                    <!-- Device Info (Editable Dropdown) -->
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Device</label>
                            <select id="editDevice" class="w-full px-3 py-2 text-sm rounded-md border border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                                <option value="">Select Device...</option>
                            </select>
                        </div>

                        <!-- Device Details Section (shown when device selected) -->
                        <div id="editDeviceDetails" class="hidden space-y-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <h5 class="text-xs font-semibold text-blue-800 uppercase tracking-wide">Device Details</h5>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="space-y-1">
                                    <label class="text-xs font-medium text-blue-700">Address</label>
                                    <input id="editAddress" type="text" readonly class="w-full px-2 py-1 text-xs rounded border border-blue-300 bg-blue-25 text-blue-800 cursor-not-allowed">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-medium text-blue-700">Device Bus</label>
                                    <input id="editBus" type="text" readonly class="w-full px-2 py-1 text-xs rounded border border-blue-300 bg-blue-25 text-blue-800 cursor-not-allowed">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-medium text-blue-700">Part Number</label>
                                    <input id="editPartNumber" type="text" readonly class="w-full px-2 py-1 text-xs rounded border border-blue-300 bg-blue-25 text-blue-800 cursor-not-allowed">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-medium text-blue-700">MAC Address</label>
                                    <input id="editMac" type="text" readonly class="w-full px-2 py-1 text-xs rounded border border-blue-300 bg-blue-25 text-blue-800 cursor-not-allowed font-mono">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Editable Fields -->
                    <div class="border-t border-gray-100 pt-4 space-y-3">
                        <div>
                            <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Object Name</label>
                            <input id="editObjectName" type="text" class="w-full px-3 py-2 text-sm rounded-md border border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                        </div>
                        <div>
                            <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Pin</label>
                            <select id="editPin" class="w-full px-3 py-2 text-sm rounded-md border border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                                <option value="">Select Pin...</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Description</label>
                            <input id="editDesc" type="text" placeholder="Optional description" class="w-full px-3 py-2 text-sm rounded-md border border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="px-4 py-3 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
                <button id="cancelEditBtnBottom" class="px-3 py-1.5 text-sm font-medium rounded hover:bg-gray-200 transition-colors">
                    Cancel
                </button>
                <button id="submitEditBtn" class="px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 transition-colors flex items-center gap-2">
                    <i data-lucide="save" class="h-3.5 w-3.5"></i>
                    Update
                </button>
            </div>
        </div>
    </div>

    <!-- Test Voice Command Modal -->
    <div id="testVoiceModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-xl border border-border/50 shadow-2xl max-w-lg w-full mx-4 overflow-hidden">
            <div class="px-6 py-5 border-b border-border/50 bg-gradient-to-r from-primary/5 to-primary/10">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-primary/10 rounded-lg">
                        <i data-lucide="message-square" class="h-5 w-5 text-primary"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-foreground">Test Voice Command</h3>
                        <p class="text-sm text-muted-foreground">Try voice commands without microphone</p>
                    </div>
                </div>
            </div>
            <div class="p-6 space-y-6">
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground">Voice Command</label>
                    <input id="testCommand" type="text" placeholder="e.g., nyalakan lampu utama" class="w-full px-4 py-3 text-sm rounded-lg border border-input bg-background focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all duration-200">
                    <div class="flex items-start gap-2 p-3 bg-muted/50 rounded-lg border border-border/30">
                        <i data-lucide="info" class="h-4 w-4 text-muted-foreground mt-0.5 flex-shrink-0"></i>
                        <div class="text-xs text-muted-foreground space-y-1">
                            <p class="font-medium">Example commands:</p>
                            <p>"nyalakan lampu", "matikan lampu", "toggle lampu"</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-border/50 bg-muted/20 flex justify-end gap-3">
                <button id="cancelTestBtn" class="px-4 py-2 text-sm font-medium rounded-lg border border-border hover:bg-muted transition-colors">Cancel</button>
                <button id="submitTestBtn" class="px-4 py-2 text-sm font-medium rounded-lg bg-primary text-primary-foreground hover:bg-primary/90 transition-colors flex items-center gap-2">
                    <i data-lucide="play" class="h-4 w-4"></i>
                    Test Command
                </button>
            </div>
        </div>
    </div>

    <!-- Device Preview Modal -->
    <div id="previewModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full overflow-hidden">
            <!-- Simple Header -->
            <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i data-lucide="eye" class="h-4 w-4 text-gray-600"></i>
                        <h3 class="text-base font-semibold text-gray-900">Device Details</h3>
                    </div>
                    <button id="closePreviewBtn" class="p-1 hover:bg-gray-200 rounded transition-colors">
                        <i data-lucide="x" class="h-4 w-4 text-gray-500"></i>
                    </button>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div class="max-h-96 overflow-y-auto">
                <div class="p-4 space-y-4">
                    <!-- Device Info -->
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Device Name</label>
                            <p id="previewDeviceName" class="text-sm font-medium text-gray-900 mt-1">-</p>
                        </div>
                        <div>
                            <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Object Name</label>
                            <p id="previewObjectName" class="text-sm font-medium text-gray-900 mt-1">-</p>
                        </div>
                        <div>
                            <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Part Number</label>
                            <p id="previewPartNumber" class="text-sm font-medium text-gray-900 mt-1">-</p>
                        </div>
                        <div>
                            <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">MAC Address</label>
                            <code id="previewMac" class="text-xs bg-gray-100 px-2 py-1 rounded mt-1 block font-mono">-</code>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Address</label>
                                <p id="previewAddress" class="text-sm font-medium text-gray-900 mt-1">-</p>
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Bus</label>
                                <p id="previewBus" class="text-sm font-medium text-gray-900 mt-1">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration -->
                    <div class="border-t border-gray-100 pt-4">
                        <h4 class="text-sm font-medium text-gray-900 mb-3">Configuration</h4>
                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Pin</label>
                                    <code id="previewPin" class="text-sm bg-gray-100 px-2 py-1 rounded mt-1 block font-mono">-</code>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Heartbeat</label>
                                    <p id="previewHeartbeatInterval" class="text-sm font-medium text-gray-900 mt-1">-</p>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Description</label>
                                <p id="previewDesc" class="text-sm text-gray-900 mt-1 leading-relaxed">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="border-t border-gray-100 pt-4">
                        <h4 class="text-sm font-medium text-gray-900 mb-3">Status</h4>
                        <div class="flex items-center gap-2 mb-3">
                            <div id="previewStatusDot" class="w-2 h-2 rounded-full bg-gray-400"></div>
                            <span id="previewStatus" class="text-sm font-medium text-gray-900">-</span>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-500">Last Seen:</span>
                                <span id="previewLastSeen" class="font-medium text-right">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Created:</span>
                                <span id="previewCreatedAt" class="font-medium text-right">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Updated:</span>
                                <span id="previewUpdatedAt" class="font-medium text-right">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Metadata -->
                    <div class="border-t border-gray-100 pt-4">
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-500 uppercase tracking-wide">Config ID:</span>
                                <code id="previewId" class="text-xs bg-gray-100 px-2 py-1 rounded font-mono">-</code>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-500 uppercase tracking-wide">Last Update:</span>
                                <span id="previewStatusUpdate" class="text-xs text-gray-600">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="px-4 py-3 border-t border-gray-200 bg-gray-50 flex justify-end">
                <button id="closePreviewBtnBottom" class="px-3 py-1.5 bg-gray-900 text-white text-sm font-medium rounded hover:bg-gray-800 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-xl border border-border/50 shadow-2xl max-w-md w-full mx-4 overflow-hidden">
            <div class="px-6 py-5 border-b border-border/50 bg-gradient-to-r from-red-50 to-red-100">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-red-100 rounded-lg">
                        <i data-lucide="alert-triangle" class="h-5 w-5 text-red-600"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-foreground">Delete Configuration</h3>
                        <p class="text-sm text-muted-foreground">This action cannot be undone</p>
                    </div>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <div class="p-4 bg-muted/50 rounded-lg border border-border/30">
                    <p class="text-sm text-muted-foreground mb-2">You are about to delete:</p>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-medium text-foreground">Object:</span>
                            <span id="deleteObjectName" class="text-sm text-muted-foreground">-</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-medium text-foreground">Device:</span>
                            <span id="deleteDeviceName" class="text-sm text-muted-foreground">-</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-medium text-foreground">Pin:</span>
                            <code id="deletePin" class="px-2 py-1 bg-muted rounded text-xs font-mono">-</code>
                        </div>
                    </div>
                </div>
                <div class="flex items-start gap-2 p-3 bg-red-50 rounded-lg border border-red-200">
                    <i data-lucide="info" class="h-4 w-4 text-red-600 mt-0.5 flex-shrink-0"></i>
                    <p class="text-sm text-red-800">This will permanently remove this voice configuration. Make sure this configuration is not currently in use.</p>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-border/50 bg-muted/20 flex justify-end gap-3">
                <button id="cancelDeleteBtn" class="px-4 py-2 text-sm font-medium rounded-lg border border-border hover:bg-muted transition-colors">Cancel</button>
                <button id="confirmDeleteBtn" class="px-4 py-2 text-sm font-medium rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors flex items-center gap-2">
                    <i data-lucide="trash-2" class="h-4 w-4"></i>
                    Delete Configuration
                </button>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Initialize Lucide Icons -->
    <script>
        lucide.createIcons();
    </script>

    <!-- Custom JavaScript -->
    <script>
        let availableDevices = [];
        let currentConfigId = null;
        let autoRefreshInterval = null;
        let autoRefreshEnabled = false;
        let voiceControlActive = false;

        // MQTT status tracking (via backend API)
        let isMqttConnected = false;

        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableDevices();
            loadConfigurations();
            updateStats();
            setupSearchAndFilter();
            setupKeyboardShortcuts();
            setupModalHandlers();
            setupVoiceControlHandlers();
            setupRefreshHandler();

            // Start periodic MQTT status updates
            setInterval(updateMqttStatus, 5000); // Check every 5 seconds

            // Start periodic voice result updates (for real-time voice commands)
            setInterval(updateVoiceResults, 1000); // Check every 1 second for faster updates
        });

        // Update voice results from backend (for real-time voice commands)
        async function updateVoiceResults() {
            try {
                const response = await fetch('/api/voice/last-result');
                const data = await response.json();

                if (data.status === 'success' && data.result && data.result.command_text) {
                    // Only update if there's actual command data (not empty result)
                    const result = data.result;

                    // Create a mock result object for the UI update function
                    const mockResult = {
                        success: result.success,
                        status: result.success ? 'success' : 'warning',
                        details: result
                    };

                    // Update the voice results card
                    updateVoiceResultsCard(mockResult, result.command_text);

                    console.log('Voice command result updated:', result); // Debug log
                }
            } catch (error) {
                // Silently fail - don't spam console with polling errors
                console.debug('Voice results polling:', error);
            }
        }

        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableDevices();
            loadConfigurations();
            updateStats();
            setupSearchAndFilter();
            setupKeyboardShortcuts();
            setupModalHandlers();
            setupVoiceControlHandlers();
            setupRefreshHandler();

            // Start periodic MQTT status updates
            setInterval(updateMqttStatus, 5000); // Check every 5 seconds

            // Start periodic voice result updates (for real-time voice commands)
            setInterval(updateVoiceResults, 2000); // Check every 2 seconds
        });

        // Load available devices
        async function loadAvailableDevices() {
            try {
                const response = await fetch('/api/devices/available');
                const data = await response.json();

                if (data.status === 'success') {
                    availableDevices = data.devices;
                    updateDeviceDropdowns();
                }
            } catch (error) {
                console.error('Error loading devices:', error);
                showAlert('Error loading available devices', 'error');
            }
        }

        // Update device dropdowns in modals
        function updateDeviceDropdowns() {
            const createSelect = document.getElementById('createDevice');
            const editSelect = document.getElementById('editDevice');

            // Update create modal dropdown
            createSelect.innerHTML = '<option value="">Select Device...</option>';
            availableDevices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.name;
                option.textContent = `${device.name} (${device.part_number})`;
                option.dataset.device = JSON.stringify(device);
                createSelect.appendChild(option);
            });

            // Update edit modal dropdown
            editSelect.innerHTML = '<option value="">Select Device...</option>';
            availableDevices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.name;
                option.textContent = `${device.name} (${device.part_number})`;
                option.dataset.device = JSON.stringify(device);
                editSelect.appendChild(option);
            });
        }

        // Setup modal handlers
        function setupModalHandlers() {
            // Create Configuration Modal
            document.getElementById('createConfigBtn').addEventListener('click', () => {
                document.getElementById('createModal').style.display = 'flex';
            });

            document.getElementById('cancelCreateBtn').addEventListener('click', () => {
                document.getElementById('createModal').style.display = 'none';
                // Reset form and hide device details
                const form = document.getElementById('createModal').querySelector('form') || document.createElement('form');
                if (form.reset) form.reset();
                document.getElementById('deviceDetails').classList.add('hidden');
                document.getElementById('createAddress').value = '';
                document.getElementById('createBus').value = '';
                document.getElementById('createPartNumber').value = '';
                document.getElementById('createMac').value = '';
                document.getElementById('createPin').innerHTML = '<option value="">Select Pin...</option>';
            });

            document.getElementById('submitCreateBtn').addEventListener('click', createConfiguration);

            // Edit Configuration Modal
            document.getElementById('cancelEditBtn').addEventListener('click', () => {
                document.getElementById('editModal').style.display = 'none';
            });

            document.getElementById('cancelEditBtnBottom').addEventListener('click', () => {
                document.getElementById('editModal').style.display = 'none';
            });

            document.getElementById('submitEditBtn').addEventListener('click', updateConfiguration);

            // Test Voice Command Modal
            document.getElementById('testVoiceBtn').addEventListener('click', () => {
                document.getElementById('testVoiceModal').style.display = 'flex';
            });

            document.getElementById('cancelTestBtn').addEventListener('click', () => {
                document.getElementById('testVoiceModal').style.display = 'none';
                document.getElementById('testCommand').value = '';
            });

            document.getElementById('submitTestBtn').addEventListener('click', testVoiceCommand);

            // Device Preview Modal
            document.getElementById('closePreviewBtn').addEventListener('click', () => {
                document.getElementById('previewModal').style.display = 'none';
            });

            document.getElementById('closePreviewBtnBottom').addEventListener('click', () => {
                document.getElementById('previewModal').style.display = 'none';
            });

            // Delete Confirmation Modal
            document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                document.getElementById('deleteModal').style.display = 'none';
            });

            document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                const configId = document.getElementById('confirmDeleteBtn').dataset.configId;
                if (configId) {
                    performDeleteConfiguration(configId);
                }
            });

            // Close modals when clicking outside
            document.querySelectorAll('.fixed.inset-0').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });

            // Handle device selection in create modal
            document.getElementById('createDevice').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const deviceDetailsDiv = document.getElementById('deviceDetails');

                if (this.value) {
                    const device = JSON.parse(selectedOption.dataset.device);

                    // Show device details section
                    deviceDetailsDiv.classList.remove('hidden');

                    // Populate device details fields
                    document.getElementById('createAddress').value = device.address || '';
                    document.getElementById('createBus').value = device.device_bus || '0';
                    document.getElementById('createPartNumber').value = device.part_number || '';
                    document.getElementById('createMac').value = device.mac || '';

                    // Load pins for device type
                    loadPinsForDevice(device.part_number, 'createPin');
                } else {
                    // Hide device details section and reset fields
                    deviceDetailsDiv.classList.add('hidden');
                    document.getElementById('createAddress').value = '';
                    document.getElementById('createBus').value = '';
                    document.getElementById('createPartNumber').value = '';
                    document.getElementById('createMac').value = '';
                    document.getElementById('createPin').innerHTML = '<option value="">Select Pin...</option>';
                }
            });

            // Handle device selection in edit modal
            document.getElementById('editDevice').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const deviceDetailsDiv = document.getElementById('editDeviceDetails');

                if (this.value) {
                    const device = JSON.parse(selectedOption.dataset.device);

                    // Show device details section
                    deviceDetailsDiv.classList.remove('hidden');

                    // Populate device details fields
                    document.getElementById('editAddress').value = device.address || '';
                    document.getElementById('editBus').value = device.device_bus || '0';
                    document.getElementById('editPartNumber').value = device.part_number || '';
                    document.getElementById('editMac').value = device.mac || '';

                    // Load pins for device type
                    loadPinsForDevice(device.part_number, 'editPin');
                } else {
                    // Hide device details section and reset fields
                    deviceDetailsDiv.classList.add('hidden');
                    document.getElementById('editAddress').value = '';
                    document.getElementById('editBus').value = '';
                    document.getElementById('editPartNumber').value = '';
                    document.getElementById('editMac').value = '';
                    document.getElementById('editPin').innerHTML = '<option value="">Select Pin...</option>';
                }
            });
        }

        // Setup voice control handlers
        function setupVoiceControlHandlers() {
            document.getElementById('startVoiceBtn').addEventListener('click', startVoiceControl);
            document.getElementById('stopVoiceBtn').addEventListener('click', stopVoiceControl);
            document.getElementById('discoverDevicesBtn').addEventListener('click', discoverDevices);
        }

        // Setup refresh button handler
        function setupRefreshHandler() {
            document.getElementById('refreshBtn').addEventListener('click', function() {
                window.location.reload();
            });
        }

        // Load pins for device type
        async function loadPinsForDevice(partNumber, pinSelectId) {
            try {
                const response = await fetch(`/api/pins/${partNumber}`);
                const data = await response.json();

                if (data.status === 'success') {
                    const pinSelect = document.getElementById(pinSelectId);
                    pinSelect.innerHTML = '<option value="">Select Pin...</option>';

                    data.pins.forEach(pin => {
                        const option = document.createElement('option');
                        option.value = pin;
                        option.textContent = pin;
                        pinSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading pins:', error);
            }
        }

        // Create configuration
        async function createConfiguration() {
            const deviceSelect = document.getElementById('createDevice');
            const selectedOption = deviceSelect.options[deviceSelect.selectedIndex];

            if (!selectedOption.value) {
                showAlert('Please select a device', 'error');
                return;
            }

            const device = JSON.parse(selectedOption.dataset.device);
            const data = {
                device_name: deviceSelect.value,
                objectName: document.getElementById('createObjectName').value,
                pin: document.getElementById('createPin').value,
                desc: document.getElementById('createDesc').value,
                address: device.address,
                bus: device.device_bus,
                part_number: device.part_number,
                mac: device.mac
            };

            if (!data.objectName || !data.pin) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }

            try {
                const response = await fetch('/api/configurations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showAlert('Configuration created successfully', 'success');

                    // Close modal and reset form first
                    document.getElementById('createModal').style.display = 'none';
                    document.getElementById('createForm').reset();

                    // Force immediate refresh of data
                    setTimeout(async () => {
                        try {
                            await loadConfigurations();
                            await updateStats();
                        } catch (error) {
                            console.error('Error refreshing data after creation:', error);
                            // Fallback: reload the page if refresh fails
                            window.location.reload();
                        }
                    }, 500);
                } else {
                    console.error('Configuration creation failed:', result);
                    showAlert(result.message || 'Error creating configuration', 'error');
                }
            } catch (error) {
                console.error('Error creating configuration:', error);
                showAlert('Error creating configuration', 'error');
            }
        }

        // Edit configuration
        function editConfiguration(id) {
            // Find configuration
            fetch('/api/configurations')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const config = data.data.find(c => c.id === id);
                        if (config) {
                            currentConfigId = id;
                            document.getElementById('editId').value = id;
                            document.getElementById('editDevice').value = config.device_name;
                            document.getElementById('editObjectName').value = config.object_name || '';
                            document.getElementById('editDesc').value = config.desc || '';

                            // Load pins for this device type
                            loadPinsForDevice(config.part_number, 'editPin').then(() => {
                                document.getElementById('editPin').value = config.pin || '';
                            });

                            document.getElementById('editModal').style.display = 'flex';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading configuration for edit:', error);
                    showAlert('Error loading configuration', 'error');
                });
        }

        // Update configuration
        async function updateConfiguration() {
            if (!currentConfigId) return;

            const deviceSelect = document.getElementById('editDevice');
            const selectedOption = deviceSelect.options[deviceSelect.selectedIndex];
            const deviceChanged = selectedOption && selectedOption.value;

            const data = {
                desc: document.getElementById('editDesc').value,
                objectName: document.getElementById('editObjectName').value,
                pin: document.getElementById('editPin').value
            };

            // If device was changed, include device-related fields
            if (deviceChanged) {
                const device = JSON.parse(selectedOption.dataset.device);
                data.device_name = deviceSelect.value;
                data.address = device.address;
                data.bus = device.device_bus;
                data.part_number = device.part_number;
                data.mac = device.mac;
            }

            try {
                const response = await fetch(`/api/configurations/${currentConfigId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showAlert('Configuration updated successfully', 'success');
                    document.getElementById('editModal').style.display = 'none';

                    // Auto-refresh data after successful update
                    setTimeout(() => {
                        loadConfigurations();
                        updateStats();
                    }, 300);
                } else {
                    showAlert(result.message || 'Error updating configuration', 'error');
                }
            } catch (error) {
                console.error('Error updating configuration:', error);
                showAlert('Error updating configuration', 'error');
            }
        }

        // Delete configuration
        async function deleteConfiguration(id) {
            if (!confirm('Are you sure you want to delete this configuration?')) return;

            try {
                const response = await fetch(`/api/configurations/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showAlert('Configuration deleted successfully', 'success');
                    loadConfigurations();
                    updateStats();
                } else {
                    showAlert(result.message || 'Error deleting configuration', 'error');
                }
            } catch (error) {
                console.error('Error deleting configuration:', error);
                showAlert('Error deleting configuration', 'error');
            }
        }

        // Voice Control Functions
        async function startVoiceControl() {
            try {
                const response = await fetch('/api/voice/start', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.status === 'success') {
                    voiceControlActive = true;
                    document.getElementById('startVoiceBtn').style.display = 'none';
                    document.getElementById('stopVoiceBtn').style.display = 'inline-flex';
                    updateVoiceControlStatus('Active', 'emerald');
                    showAlert('Voice control started successfully', 'success');
                } else {
                    showAlert(result.message || 'Failed to start voice control', 'error');
                }
            } catch (error) {
                console.error('Error starting voice control:', error);
                showAlert('Error starting voice control', 'error');
            }
        }

        async function stopVoiceControl() {
            try {
                const response = await fetch('/api/voice/stop', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.status === 'success') {
                    voiceControlActive = false;
                    document.getElementById('startVoiceBtn').style.display = 'inline-flex';
                    document.getElementById('stopVoiceBtn').style.display = 'none';
                    updateVoiceControlStatus('Inactive', 'gray');

                    // Hide voice results card when stopping voice control
                    const voiceResultsCard = document.getElementById('voiceResultsCard');
                    voiceResultsCard.style.display = 'none';

                    showAlert('Voice control stopped', 'info');
                } else {
                    showAlert(result.message || 'Failed to stop voice control', 'error');
                }
            } catch (error) {
                console.error('Error stopping voice control:', error);
                showAlert('Error stopping voice control', 'error');
            }
        }

        // Update voice control status in UI
        function updateVoiceControlStatus(status, color) {
            const statusDiv = document.getElementById('voiceControlStatus');
            statusDiv.innerHTML = `
                <div class="w-2 h-2 rounded-full bg-${color}-500"></div>
                <span class="text-sm font-medium">${status}</span>
            `;
        }

        // Test voice command
        async function testVoiceCommand() {
            const commandInput = document.getElementById('testCommand');
            const command = commandInput.value.trim();

            if (!command) {
                showAlert('Please enter a command to test', 'error');
                return;
            }

            try {
                // Show loading state
                showAlert('Processing voice command...', 'info');

                const response = await fetch('/api/voice/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ command: command })
                });

                const result = await response.json();

                // Update voice results card
                updateVoiceResultsCard(result, command);

                // Show appropriate alert
                if (result.status === 'success') {
                    showAlert(`✅ Command processed successfully: "${command}"`, 'success');
                } else {
                    showAlert(`⚠️ Command processed with warning: "${command}"`, 'info');
                }

                // Clear input
                commandInput.value = '';

            } catch (error) {
                console.error('Error testing voice command:', error);
                showAlert('Error testing voice command', 'error');
            }
        }

        // Update voice results card with command details
        function updateVoiceResultsCard(result, originalCommand) {
            const card = document.getElementById('voiceResultsCard');
            const details = result.details || {};

            // Show the card
            card.style.display = 'block';

            // Update status badge
            const statusBadge = document.getElementById('commandStatusBadge');
            if (result.success || result.status === 'success') {
                statusBadge.className = 'inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-200';
                statusBadge.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div><span>Success</span>';
            } else {
                statusBadge.className = 'inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-red-50 text-red-700 border border-red-200';
                statusBadge.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-red-500"></div><span>Failed</span>';
            }

            // Update recognized text
            document.getElementById('recognizedText').textContent = originalCommand;

            // Update detected action
            document.getElementById('detectedAction').textContent = details.action || 'None';

            // Update target device
            document.getElementById('targetDevice').textContent = details.object_name || 'None';

            // Update device details section
            const deviceSection = document.getElementById('deviceDetailsSection');
            if (details.device_found) {
                deviceSection.style.display = 'block';
                document.getElementById('deviceNameDetail').textContent = details.device_name || '-';
                document.getElementById('devicePinDetail').textContent = details.pin || '-';
                document.getElementById('mqttStatusDetail').textContent = details.mqtt_success ? 'Success' : 'Failed';
            } else {
                deviceSection.style.display = 'none';
            }

            // Update error section
            const errorSection = document.getElementById('errorSection');
            if (details.error_message) {
                errorSection.style.display = 'block';
                document.getElementById('errorMessage').textContent = details.error_message;
            } else {
                errorSection.style.display = 'none';
            }

            // Update timestamp
            const timestamp = details.timestamp ? new Date(details.timestamp).toLocaleString('id-ID') : new Date().toLocaleString('id-ID');
            document.getElementById('commandTimestamp').textContent = `Last updated: ${timestamp}`;

            // Scroll to results card
            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Discover devices
        async function discoverDevices() {
            try {
                showAlert('Initiating device discovery...', 'info');

                const response = await fetch('/api/devices/discover', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showAlert('Device discovery initiated successfully. Devices will announce themselves via MQTT.', 'success');

                    // Refresh device list after a short delay
                    setTimeout(() => {
                        loadAvailableDevices();
                        loadConfigurations();
                    }, 2000);
                } else {
                    showAlert(result.message || 'Failed to initiate device discovery', 'error');
                }
            } catch (error) {
                console.error('Error discovering devices:', error);
                showAlert('Error initiating device discovery', 'error');
            }
        }

        // Load configurations
        async function loadConfigurations() {
            try {
                const tbody = document.getElementById('configTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-muted-foreground">
                            <div class="flex flex-col items-center gap-2">
                                <i data-lucide="loader-2" class="h-8 w-8 animate-spin"></i>
                                <p>Loading configurations...</p>
                            </div>
                        </td>
                    </tr>
                `;

                const timestamp = Date.now();
                const response = await fetch(`/api/configurations?t=${timestamp}`, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                const data = await response.json();

                tbody.innerHTML = '';

                if (data.status === 'success') {
                    let filteredData = data.data;

                    // Apply search filter
                    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
                    const searchType = document.getElementById('searchTypeSelect').value;

                    if (searchTerm) {
                        filteredData = filteredData.filter(config => {
                            switch (searchType) {
                                case 'object_name':
                                    return config.object_name?.toLowerCase().includes(searchTerm);
                                case 'device_name':
                                    return config.device_name?.toLowerCase().includes(searchTerm);
                                case 'part_number':
                                    return config.part_number?.toLowerCase().includes(searchTerm);
                                case 'pin':
                                    return config.pin?.toLowerCase().includes(searchTerm);
                                case 'description':
                                    return config.desc?.toLowerCase().includes(searchTerm);
                                case 'status':
                                    // For status search, check device status
                                    const statusText = config.realStatus || 'unknown';
                                    return statusText.toLowerCase().includes(searchTerm);
                                case 'all':
                                default:
                                    return config.object_name?.toLowerCase().includes(searchTerm) ||
                                           config.device_name?.toLowerCase().includes(searchTerm) ||
                                           config.part_number?.toLowerCase().includes(searchTerm) ||
                                           config.pin?.toLowerCase().includes(searchTerm) ||
                                           config.desc?.toLowerCase().includes(searchTerm) ||
                                           (config.realStatus || 'unknown').toLowerCase().includes(searchTerm);
                            }
                        });
                    }

                    // Process configurations with real status first, then apply search filter
                    const statusPromises = data.data.map(config =>
                        fetch(`/api/devices/status/${config.mac}`)
                            .then(response => response.json())
                            .then(data => ({
                                ...config,
                                realStatus: data.status === 'success' ? data.device_status : 'unknown'
                            }))
                            .catch(error => ({
                                ...config,
                                realStatus: 'unknown'
                            }))
                    );

                    Promise.all(statusPromises).then(allConfigsWithStatus => {
                        // Apply search filter after we have all status data
                        let filteredData = allConfigsWithStatus;

                        const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
                        const searchType = document.getElementById('searchTypeSelect').value;

                        if (searchTerm) {
                            filteredData = filteredData.filter(config => {
                                switch (searchType) {
                                    case 'object_name':
                                        return config.object_name?.toLowerCase().includes(searchTerm);
                                    case 'device_name':
                                        return config.device_name?.toLowerCase().includes(searchTerm);
                                    case 'part_number':
                                        return config.part_number?.toLowerCase().includes(searchTerm);
                                    case 'pin':
                                        return config.pin?.toLowerCase().includes(searchTerm);
                                    case 'description':
                                        return config.desc?.toLowerCase().includes(searchTerm);
                                    case 'status':
                                        // For status search, check device status
                                        const statusText = config.realStatus || 'unknown';
                                        return statusText.toLowerCase().includes(searchTerm);
                                    case 'all':
                                    default:
                                        return config.object_name?.toLowerCase().includes(searchTerm) ||
                                               config.device_name?.toLowerCase().includes(searchTerm) ||
                                               config.part_number?.toLowerCase().includes(searchTerm) ||
                                               config.pin?.toLowerCase().includes(searchTerm) ||
                                               config.desc?.toLowerCase().includes(searchTerm) ||
                                               (config.realStatus || 'unknown').toLowerCase().includes(searchTerm);
                                }
                            });
                        }

                        tbody.innerHTML = ''; // Clear loading state

                        if (filteredData.length === 0) {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="7" class="px-4 py-8 text-center text-muted-foreground">
                                        <div class="flex flex-col items-center gap-2">
                                            <i data-lucide="search" class="h-8 w-8"></i>
                                            <p>No configurations found matching your criteria</p>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        } else {
                            filteredData.forEach((config, index) => {
                                let statusColor, statusText;

                                switch (config.realStatus) {
                                    case 'online':
                                        statusColor = 'emerald';
                                        statusText = 'Online';
                                        break;
                                    case 'offline':
                                        statusColor = 'slate';
                                        statusText = 'Offline';
                                        break;
                                    default:
                                        statusColor = 'yellow';
                                        statusText = 'Unknown';
                                }

                                const row = document.createElement('tr');
                                row.className = 'hover:bg-muted/30 transition-colors';
                                row.innerHTML = `
                                    <td class="px-6 py-4 text-center">
                                        <span class="text-sm font-medium text-muted-foreground">${index + 1}</span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="font-medium text-foreground">${config.object_name || '-'}</div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="space-y-1">
                                            <div class="font-medium text-foreground">${config.device_name}</div>
                                            <div class="text-xs text-muted-foreground">${config.part_number}</div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-${statusColor}-50 text-${statusColor}-700 border border-${statusColor}-200">
                                            <div class="w-1.5 h-1.5 rounded-full bg-${statusColor}-500"></div>
                                            <span>${statusText}</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <code class="px-2 py-1 bg-muted/50 rounded text-xs font-mono text-foreground">${config.pin || '-'}</code>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="text-sm text-muted-foreground max-w-xs truncate" title="${config.desc || '-'}">${config.desc || '-'}</div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="flex items-center justify-center gap-1">
                                            <button class="inline-flex items-center justify-center h-8 w-8 rounded-md border border-border hover:bg-muted transition-colors" title="Preview Data" onclick="previewDevice('${config.id}')">
                                                <i data-lucide="eye" class="h-3.5 w-3.5 text-muted-foreground"></i>
                                            </button>
                                            <button class="inline-flex items-center justify-center h-8 w-8 rounded-md border border-border hover:bg-muted transition-colors" title="Edit" onclick="editConfiguration('${config.id}')">
                                                <i data-lucide="edit-2" class="h-3.5 w-3.5 text-muted-foreground"></i>
                                            </button>
                                            <button class="inline-flex items-center justify-center h-8 w-8 rounded-md border border-destructive/50 text-destructive hover:bg-destructive/10 hover:border-destructive transition-colors" title="Delete" onclick="deleteConfiguration('${config.id}')">
                                                <i data-lucide="trash-2" class="h-3.5 w-3.5"></i>
                                            </button>
                                        </div>
                                    </td>
                                `;
                                tbody.appendChild(row);
                            });
                        }

                        // Re-initialize Lucide icons for new elements
                        lucide.createIcons();
                    }).catch(error => {
                        console.error('Error fetching device statuses:', error);
                        // Fallback: show all data without status
                        tbody.innerHTML = '';
                        data.data.forEach((config, index) => {
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-muted/30 transition-colors';
                            row.innerHTML = `
                                <td class="px-6 py-4 text-center">
                                    <span class="text-sm font-medium text-muted-foreground">${index + 1}</span>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="font-medium text-foreground">${config.object_name || '-'}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="space-y-1">
                                        <div class="font-medium text-foreground">${config.device_name}</div>
                                        <div class="text-xs text-muted-foreground">${config.part_number}</div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-yellow-50 text-yellow-700 border border-yellow-200">
                                        <div class="w-1.5 h-1.5 rounded-full bg-yellow-500"></div>
                                        <span>Unknown</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <code class="px-2 py-1 bg-muted/50 rounded text-xs font-mono text-foreground">${config.pin || '-'}</code>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-muted-foreground max-w-xs truncate" title="${config.desc || '-'}">${config.desc || '-'}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center justify-center gap-1">
                                        <button class="inline-flex items-center justify-center h-8 w-8 rounded-md border border-border hover:bg-muted transition-colors" title="Preview Data">
                                            <i data-lucide="eye" class="h-3.5 w-3.5 text-muted-foreground"></i>
                                        </button>
                                        <button class="inline-flex items-center justify-center h-8 w-8 rounded-md border border-border hover:bg-muted transition-colors" title="Edit" onclick="editConfiguration('${config.id}')">
                                            <i data-lucide="edit-2" class="h-3.5 w-3.5 text-muted-foreground"></i>
                                        </button>
                                        <button class="inline-flex items-center justify-center h-8 w-8 rounded-md border border-destructive/50 text-destructive hover:bg-destructive/10 hover:border-destructive transition-colors" title="Delete" onclick="deleteConfiguration('${config.id}')">
                                            <i data-lucide="trash-2" class="h-3.5 w-3.5"></i>
                                        </button>
                                    </div>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                        lucide.createIcons();
                    });
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-destructive">
                                <div class="flex flex-col items-center gap-2">
                                    <i data-lucide="alert-triangle" class="h-8 w-8"></i>
                                    <p>Error loading configurations: ${data.message || 'Unknown error'}</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    lucide.createIcons();
                }
            } catch (error) {
                console.error('Error loading configurations:', error);
                const tbody = document.getElementById('configTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-destructive">
                            <div class="flex flex-col items-center gap-2">
                                <i data-lucide="alert-triangle" class="h-8 w-8"></i>
                                <p>Network error: Unable to load configurations</p>
                            </div>
                        </td>
                    </tr>
                `;
                lucide.createIcons();
                showAlert('Network error: Unable to load configurations', 'error');
            }
        }

        // Update statistics
        async function updateStats() {
            try {
                // Update device count
                document.getElementById('totalDevices').textContent = availableDevices.length;

                // Update configuration count
                const configResponse = await fetch('/api/configurations');
                const configData = await configResponse.json();
                if (configData.status === 'success') {
                    document.getElementById('totalConfigs').textContent = configData.data.length;
                    document.getElementById('totalConfigsCount').textContent = configData.data.length;
                }

                // Update MQTT status
                await updateMqttStatus();

            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Update MQTT status indicator
        async function updateMqttStatus() {
            try {
                const mqttResponse = await fetch('/api/status/mqtt');
                const mqttData = await mqttResponse.json();

                const mqttBtn = document.getElementById('mqttStatusBtn');

                // Check if MQTT is connected (either frontend or backend)
                if (mqttData.mqtt_connected) {
                    mqttBtn.className = 'flex items-center gap-2 px-3 py-1.5 text-xs rounded-full border transition-all duration-200 bg-emerald-100 text-emerald-700 border-emerald-200 hover:bg-emerald-200';
                    mqttBtn.innerHTML = '<div class="w-1 h-1 rounded-full bg-emerald-500"></div>MQTT Connected';
                } else {
                    mqttBtn.className = 'flex items-center gap-2 px-3 py-1.5 text-xs rounded-full border transition-all duration-200 bg-slate-100 text-slate-600 border-slate-200 hover:bg-slate-200';
                    mqttBtn.innerHTML = '<div class="w-1 h-1 rounded-full bg-slate-400"></div>MQTT Disconnected';
                }
            } catch (mqttError) {
                console.error('Error checking MQTT status:', mqttError);
                const mqttBtn = document.getElementById('mqttStatusBtn');
                mqttBtn.className = 'flex items-center gap-2 px-3 py-1.5 text-xs rounded-full border transition-all duration-200 bg-red-100 text-red-700 border-red-200 hover:bg-red-200';
                mqttBtn.innerHTML = '<div class="w-1 h-1 rounded-full bg-red-500"></div>MQTT Error';
            }
        }

        // Search and Filter
        function setupSearchAndFilter() {
            const searchInput = document.getElementById('searchInput');

            searchInput.addEventListener('input', debounce(() => {
                loadConfigurations();
            }, 300));
        }

        // Debounce utility
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Keyboard Shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl + R: Refresh data
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    loadConfigurations();
                    loadAvailableDevices();
                    updateStats();
                    showAlert('Data refreshed', 'success');
                }

                // Ctrl + F: Focus search
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('searchInput').focus();
                }

                // Ctrl + ,: New Config
                if (e.ctrlKey && e.key === ',') {
                    e.preventDefault();
                    document.getElementById('createConfigBtn').click();
                }
            });
        }

        // Show alert
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');

            const alertDiv = document.createElement('div');
            alertDiv.className = `animate-in slide-in-from-top-2 flex items-center gap-2 px-4 py-3 text-sm rounded-lg border ${
                type === 'success'
                    ? 'bg-green-50 text-green-800 border-green-200'
                    : type === 'error'
                    ? 'bg-red-50 text-red-800 border-red-200'
                    : 'bg-blue-50 text-blue-800 border-blue-200'
            }`;

            const iconName = type === 'success' ? 'check-circle' : type === 'error' ? 'alert-triangle' : 'info';
            alertDiv.innerHTML = `
                <i data-lucide="${iconName}" class="h-4 w-4"></i>
                <span>${message}</span>
            `;

            alertContainer.appendChild(alertDiv);
            lucide.createIcons();

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Edit configuration
        async function editConfiguration(id) {
            try {
                // Show loading state
                showAlert('Loading configuration...', 'info');

                const response = await fetch('/api/configurations');
                const data = await response.json();

                if (data.status === 'success') {
                    const config = data.data.find(c => c.id === id);
                    if (config) {
                        currentConfigId = id;
                        document.getElementById('editId').value = id;
                        document.getElementById('editDevice').value = config.device_name;
                        document.getElementById('editObjectName').value = config.object_name || '';
                        document.getElementById('editDesc').value = config.desc || '';

                        // Load pins for this device type and set the current pin
                        await loadPinsForDevice(config.part_number, 'editPin');
                        document.getElementById('editPin').value = config.pin || '';

                        // Show the modal
                        document.getElementById('editModal').style.display = 'flex';

                        // Clear the loading alert
                        setTimeout(() => {
                            // Remove the loading alert by clearing all alerts and showing success
                            document.getElementById('alertContainer').innerHTML = '';
                        }, 500);
                    } else {
                        showAlert('Configuration not found', 'error');
                    }
                } else {
                    showAlert('Error loading configuration data', 'error');
                }
            } catch (error) {
                console.error('Error loading configuration for edit:', error);
                showAlert('Error loading configuration', 'error');
            }
        }

        // Delete configuration - show confirmation modal
        async function deleteConfiguration(id) {
            try {
                // Show loading state
                showAlert('Loading configuration details...', 'info');

                const response = await fetch('/api/configurations');
                const data = await response.json();

                if (data.status === 'success') {
                    const config = data.data.find(c => c.id === id);
                    if (config) {
                        // Populate the delete modal with configuration details
                        document.getElementById('deleteObjectName').textContent = config.object_name || '-';
                        document.getElementById('deleteDeviceName').textContent = config.device_name || '-';
                        document.getElementById('deletePin').textContent = config.pin || '-';

                        // Store the config ID in the confirm button
                        document.getElementById('confirmDeleteBtn').dataset.configId = id;

                        // Show the modal
                        document.getElementById('deleteModal').style.display = 'flex';

                        // Clear the loading alert
                        setTimeout(() => {
                            document.getElementById('alertContainer').innerHTML = '';
                        }, 500);
                    } else {
                        showAlert('Configuration not found', 'error');
                    }
                } else {
                    showAlert('Error loading configuration data', 'error');
                }
            } catch (error) {
                console.error('Error loading configuration for deletion:', error);
                showAlert('Error loading configuration', 'error');
            }
        }

        // Perform the actual deletion
        async function performDeleteConfiguration(id) {
            try {
                const response = await fetch(`/api/configurations/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showAlert('Configuration deleted successfully', 'success');
                    document.getElementById('deleteModal').style.display = 'none';

                    // Auto-refresh data after successful deletion
                    setTimeout(() => {
                        loadConfigurations();
                        updateStats();
                    }, 300);
                } else {
                    showAlert(result.message || 'Error deleting configuration', 'error');
                }
            } catch (error) {
                console.error('Error deleting configuration:', error);
                showAlert('Error deleting configuration', 'error');
            }
        }

        // Preview device details
        async function previewDevice(id) {
            try {
                showAlert('Loading device details...', 'info');

                // Fetch configuration data
                const configResponse = await fetch('/api/configurations');
                const configData = await configResponse.json();

                if (configData.status === 'success') {
                    const config = configData.data.find(c => c.id === id);
                    if (config) {
                        // Fetch device status
                        const statusResponse = await fetch(`/api/devices/status/${config.mac}`);
                        const statusData = await statusResponse.json();
                        const deviceStatus = statusData.status === 'success' ? statusData.device_status : 'unknown';

                        // Populate modal fields
                        document.getElementById('previewDeviceName').textContent = config.device_name || '-';
                        document.getElementById('previewObjectName').textContent = config.object_name || '-';
                        document.getElementById('previewPartNumber').textContent = config.part_number || '-';
                        document.getElementById('previewMac').textContent = config.mac || '-';
                        document.getElementById('previewAddress').textContent = config.address || '-';
                        document.getElementById('previewBus').textContent = config.device_bus || '-';
                        document.getElementById('previewPin').textContent = config.pin || '-';
                        document.getElementById('previewHeartbeatInterval').textContent = config.heartbeat_interval || '30';
                        document.getElementById('previewDesc').textContent = config.desc || '-';
                        document.getElementById('previewDesc').title = config.desc || '-';
                        document.getElementById('previewId').textContent = config.id || '-';

                        // Status information
                        const statusDot = document.getElementById('previewStatusDot');
                        const statusText = document.getElementById('previewStatus');

                        switch (deviceStatus) {
                            case 'online':
                                statusDot.className = 'w-2 h-2 rounded-full bg-emerald-500';
                                statusText.textContent = 'Online';
                                statusText.className = 'text-sm font-medium text-emerald-700';
                                break;
                            case 'offline':
                                statusDot.className = 'w-2 h-2 rounded-full bg-slate-500';
                                statusText.textContent = 'Offline';
                                statusText.className = 'text-sm font-medium text-slate-700';
                                break;
                            default:
                                statusDot.className = 'w-2 h-2 rounded-full bg-yellow-500';
                                statusText.textContent = 'Unknown';
                                statusText.className = 'text-sm font-medium text-yellow-700';
                        }

                        // Timestamps
                        document.getElementById('previewLastSeen').textContent = config.last_seen ? formatDateTime(config.last_seen) : 'Never';
                        document.getElementById('previewCreatedAt').textContent = config.created_at ? formatDateTime(config.created_at) : '-';
                        document.getElementById('previewUpdatedAt').textContent = config.updated_at ? formatDateTime(config.updated_at) : '-';
                        document.getElementById('previewStatusUpdate').textContent = new Date().toLocaleString();

                        // Show modal
                        document.getElementById('previewModal').style.display = 'flex';

                        // Clear loading alert
                        setTimeout(() => {
                            document.getElementById('alertContainer').innerHTML = '';
                        }, 500);
                    } else {
                        showAlert('Configuration not found', 'error');
                    }
                } else {
                    showAlert('Error loading configuration data', 'error');
                }
            } catch (error) {
                console.error('Error loading device details:', error);
                showAlert('Error loading device details', 'error');
            }
        }

        // Format date/time for display
        function formatDateTime(isoString) {
            try {
                const date = new Date(isoString.replace('Z', ''));
                return date.toLocaleString('id-ID', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZoneName: 'short'
                });
            } catch (error) {
                return isoString || '-';
            }
        }




    </script>
</body>
</html>
